<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link type="image/x-icon" rel="icon" href="favicon.ico" />
<link type="image/x-icon" rel="shortcut icon" href="favicon.ico" />
<!--[if IE]><script type="text/javascript" src="js/html5.js"></script><![endif]-->
<link rel="stylesheet" type="text/css" href="css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/vim-like.css" />
<title>Velocity-Notes - 闲耘™.Wiki</title>
</head>
<body>
<div id="wrapper">
<header>
<nav>
    <ul>
        <li class="first"><a href="http://hotoo.me/" title="Home">Home</a></li>
        <li><a href="http://blog.hotoo.me/" title="Blog">Blog</a></li>
        <li class="actived"><a href="http://wiki.hotoo.me/" title="Wiki">Wiki</a></li>
        <li><a href="https://twitter.com/hotoo" title="Twitter">Twitter</a></li>
        <li class="last"><a href="http://github.com/hotoo" title="Project">Project</a></li>
        <!-- li class="last"><a href="../resume/resume.html" title="About Me">README</a></li -->
    </ul>
</nav>
</header>
<article>

    

<h1 id="toc_1">Velocity Notes</h1>

<h2 id="toc_1.1">变量名</h2>
<dl>
<dt><code>$name</code></dt>
<dd>为空时打印变量本身。</dd>
<dt><code>$!name</code> </dt>
<dd>为空时打印空字符串（不打印任何内容）。</dd>
<dt><code>${name}</code> </dt>
<dd>类似 <code>$name</code>，为空时原样打印。但可以将变量和连续的字符串分隔，例如：<code>${name}space</code>。</dd>
<dt><code>$!{name}</code></dt>
<dd>类似 <code>$!name</code>，为空时打印空字符串，但可以将变量和连续的字符串分隔。例如： <code>$!{name}space</code>。</dd>
</dl>

<table>
<tr>
<th>
&nbsp;
</th>
<th>
$name
</th>
<th>
$!name
</th>
<th>
${name}
</th>
<th>
$!{name}
</th>
</tr>
<tr>
<td>
为空时打印：
</td>
<td>
"$name"
</td>
<td>
""
</td>
<td>
"${name}"
</td>
<td>
""
</td>
</tr>
</table>

<p>
带花括号的属性/方法调用方式，属性/方法需要在花括号之内：
</p>
<pre class="velocity">
${cookie.name}
${request.getCookies()}
</pre>

<p>
<code>#set()</code>  中，赋值符号左边的变量名不能加感叹号。
</p>
<pre>
#set($idx = 0)
#foreach($!item in $!list)
    #set($idx = $!idx + 1)
#end
</pre>

<p>
注：jQuery 的 <code>$.ajax()</code> 之类的代码会导致 Velocity 解析异常，好在 Javascript
语法的灵活性，可以增加无效空白 <code>$ .ajax()</code>，当然也可以使用 <code>jQuery.ajax()</code>
</p>

<h2 id="toc_1.2">#set()</h2>
<pre class="velocity">
#set($list = ["pine", "oak", "maple"])
</pre>
<p>
<strong>注：</strong> 如果右侧的值为 null，则赋值失败，左侧变量仍保持原值。
</p>

<h2 id="toc_1.3">#if()</h2>
<pre class="velocity">
#if(true)
    TRUE.
#elseif(false)
    FALSE.
#end
</pre>

<p>
其实不仅仅是变量名可以使用花括号，保留字同样可以使用，这在内联 Velocity 脚本的时候
非常有用。
例如：
</p>
<pre class="velocity">
<div class="#{if}(false)className1#{elseif}(true)className2#{else}className3#{end}"></div>
</pre>

<h2 id="toc_1.4">#foreach()</h2>
<pre class="velocity">
#foreach($item in $list)
    ${velocityCount}. $item.
#end
</pre>

<h2 id="toc_1.5">#break</h2>
<p>
可用于中断 <code>#foreach()</code> 循环。
</p>

<h2 id="toc_1.6">#parse()</h2>
<p>
例如：a.vm 中包含如下代码
</p>
<pre class="velocity">
#parse("b.vm")
</pre>

<p>
则在解析 a.vm 页面的这行代码时，先将 b.vm 插入到其所在的位置，并解析执行，
而且 b.vm 可以共享 a.vm 中的变量。
</p>

<p>
如果 a.vm <code>#parse("b.vm")</code>，b.vm 可以直接使用 a.vm 中定义的变量。
注意：如果 b.vm 定义了同名变量，则 b.vm 中使用自身的定义。
</p>

<h2 id="toc_1.7">#evaluate()</h2>
<p>
动态执行一串字符串的值：
</p>
<pre class="velocity">
#evaluate('string with VTL #if(true)will be displayed#end')
</pre>

<h2 id="toc_1.8">#include()</h2>
<p>
将文件原文包含进当前文档中。
</p>
<pre class="velocity">
#include("a.vm" "readme.txt")
</pre>

<h2 id="toc_1.9">#define()</h2>
<p>
类似于 C 语言的 <code>#define</code> 命令。
</p>
<pre class="velocity">
    #define($hello)
        Hello ${who}!
    #end
    #set($who = "World")

    $hello
    ## 显示 "Hello World!"
</pre>

<h2 id="toc_1.10">数组 &amp; 访问</h2>
<p>
Velocity 访问数组对象，无法通过类似 arr[2] 来访问特定位置的元素。
</p>
<pre class="velocity">
#set($arr = [0, 1, 2, 3])
$arr.get(2)
</pre>
<p>
注：Velocity 中的数组对应 Java 中的 List 对象。对于 Java 原生 Array 对象，
只能够 <code>#foreach</code> 进行遍历，无法使用 <code>$arr[0]</code> 和 <code>$arr.get(0)</code> 方法。
</p>

<h2 id="toc_1.11">范围(range)</h2>
<pre class="velocity">
#foreach($item in [10..20])
    $item
#end
</pre>

<h2 id="toc_1.12">对象 &amp; 访问</h2>
<pre class="velocity">
#set($obj = {"key":"value", "name":"space"})
$obj.get("key")

#foreach(#item in $obj)
    $item
#end
</pre>
<p>
上面的 $item 取到的是 values，如果需要在遍历对象过程中，同时取到对象的 keys，
可以使用 <code>entrySet()</code> 或 <code>keySet()</code> 方法。
</p>
<pre class="velocity">
#foreach($item in $!obj.entrySet())
    $!item.key : $!item.value
#end

#foreach($item in $obj.keySet())
    $item : $obj.get($item)
#end
</pre>
<p>
<strong>注：</strong> 这种集合的遍历是无序的，即遍历顺序可能不同于 $obj 中元素的定义顺序
（据目前所知，是根据键的字母排序的）。
</p>

<p>
另外有两种不完美解决方法：
</p>
<ol>
<li>
I:
<pre class="velocity">
#set($obj = [
    {"key":"key", "value":"value"},
    {"key":"name", "value":"space"}
    ])
#foreach($item in $obj)
    $item.key : $item.value
#end
</pre>

<li>
II:
<pre class="velocity">
#set($obj = [
    ["key","value"],
    ["name","space"]
    ])
#foreach($item in $obj)
    $item.get(0) : $item.get(1)
#end
</pre>

</ol>

<p>
之所以说 <strong>不完美</strong> 是因为：对于已知的 key，本可以直接
</p>
<pre class="velocity">
$obj.get("key")
</pre>

<p>
现在只能遍历并进行比较取得，而且较早的 Velocity 版本无法使用 <code>#break</code>，
以便在找到匹配项之后立即退出循环。
</p>
<pre class="velocity">
#foreach($item in $obj)
    #if("key" == $!obj.get(0))
        #set($myKey = $!type.get(1))
        ##break
    #end
#end
</pre>

<h2 id="toc_1.13">#macros()</h2>
<pre class="velocity">
#macro(macroName)
    #subMacro("name", "value")
#end

#macro(subMacro $param1 $param2)
    this is sub macro($param1, $param2).
#end
</pre>

<p>
注意：如果 a.vm 和 b.vm 都在页面级存在同名，参数数量相同的宏，则后访问的页面
的宏不被加载。
</p>

<p>
参考：
</p>
<ol>
<li>
<a href="http://hi.baidu.com/%BA%DC%B9%AD%CB%E4%B5%C480%BA%F3/blog/item/5d0a9e81785723dfbd3e1e7f.html">Velocity宏Velocimacros</a>

</ol>

<h2 id="toc_1.14">#stop</h2>
<p>
停止模板引擎，在 Debug 时比较有用。
</p>

<h2 id="toc_1.15">条件比较</h2>
<p>
在 Velocity 中可以使用大于(&gt;)/小于(&lt;)/等于(==)之类的符号，与编程语言中的意义一致，
不过要注意的是这些符号不能直接接在变量之后，除非变量使用带花括号的表示方式。
例如：<code>if($num&gt;1)</code> 要修改为 <code>if($num &gt; 1)</code> 或 <code>if(${num}&gt;1)</code>。
</p>

<h2 id="toc_1.16">转义</h2>
<pre class="velocity">
$\name
$\{name}
</pre>

<h2 id="toc_1.17">不解析执行的内容</h2>
<pre class="velocity">
#[[
    这段内容将不被 Velocity 引擎解析，原文打出。

    * #define()
    * ${blah

]]#
</pre>

<h2 id="toc_1.18">内置对象</h2>
<p>
<code>$request</code>, <code>$response</code>, <code>$session</code>
</p>

<pre class="velocity">
#foreach($cookie in $request.getCookies())
    $cookie.name : $cookie.value
#end
</pre>

<p>
获得 URL 中的参数：
</p>
<pre class="velocity">
#set($n = $!request.getParameter('n'))
</pre>

<p>
另外还可以使用 <code>$msg</code> 内的消息工具访问 Struts 的国际化资源。
</p>

<p>
参考：
</p>
<ol>
<li>
<a href="http://download.oracle.com/javaee/1.3/api/javax/servlet/ServletRequest.html">Interface ServletRequest</a>

<li>
<a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletRequest.html">Interface HttpServletRequest</a>

</ol>

<h2 id="toc_1.19">注释</h2>
<pre class="velocity">
## 单行注释。
#*
 * 多行注释。
 *#

#**
 * 文档风格的注释。
 * @version 2010/12/27
 *#
</pre>

<p>
据说 vm 页面的末尾写注释，会导致解析异常 (SofaMVC?)。
</p>

<h2 id="toc_1.20">Tips</h2>
<p>
Velocity 在表单中添加 name="action" 的文本/隐藏域，可以调用对应 Java 类
（submit 按钮的 name 则指定对应的方法名称，如 event_submit_do_save ），
但是此时 IE 浏览器通过 js 获得 form 元素本身的 action 属性值的方式，
和其他浏览器稍有不同。
</p>

<p>
例如对于如下 HTML DOM 结构：
</p>
<pre>
&lt;form action="attr"&gt;
    &lt;input name="action" value="elem" /&gt;
&lt;/form&gt;
</pre>

<p>
IE 中需要使用
</p>
<pre class="javascript">
form.attributes["action"].value
</pre>

<p>
非 IE 浏览器还可以使用：
</p>
<pre class="javascript">
form.getAttribute("action")
</pre>

<p>
以下是些详细的对照：
</p>
<pre class="javascript">
// codes                            //  IE          !IE
form.action.value                   // elem         elem
form.getAttribute("action")         // [object]     attr
form.getAttribute("action").value   // elem         undefined
form.attributes["action"].value     // attr         attr
</pre>

<p>
Form 本身的 action 属性和 action 隐藏域在提交时，浏览器本身不受影响，
action 隐藏域被当作正常的参数附在 Form 的 action 属性值所对应 URL 之后。
</p>

<h2 id="toc_1.21">延伸阅读</h2>
<ol>
<li>
<a href="Velocity.html">Velocity</a>

<li>
<a href="Alipay-SofaMVC.html">Alipay-SofaMVC</a>

<li>
<a href="http://velocity.apache.org/engine/releases/velocity-1.7/vtl-reference-guide.html">VTL Reference</a>

<li>
<a href="http://www.uusam.com/uu/blog/?p=96">《Velocity 用户指南手册中文版》</a>

</ol>


<script type="text/javascript">
function onSearch(){
    location.href = "search.html#"+document.getElementById("input_search").value;
    return false;
}
</script>
<div style="border-top:1px solid #ccc; background:#f6f6f6 none;padding:8px;">
    <form action="search.html" id="searchbox" onsubmit="return onSearch();">
        <input type="text" name="q" id="input_search" />
        <input type="submit" value="搜索" />
    </form>
</div>
</article>
<footer>
    <a href="index.html" id="back-home">&lsaquo; 首页</a>
    <p><a rel="license" href="http://creativecommons.org/licenses/by/2.5/"><img alt="Creative Commons License" style="border-width: 0pt;" src="http://i.creativecommons.org/l/by/2.5/88x31.png" align="right"></a>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/2.5/">Creative Commons Attribution 2.5 Generic License</a>.<br>
    Copyleft © 2010, Driven by <a href="http://code.google.com/p/vimwiki/">Vimwiki</a>, Theme by 闲耘™(@hotoo).
    </p>
    <p>本页最后修订于 %time_stamp%</p>
</footer>
</div>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<!--[if lte IE 6]><script type="text/javascript" src="js/ie6.js"></script><![endif]-->
<!-- <script type="text/javascript" src="js/WikiWords.js"></script>
<script type="text/javascript" src="js/vim-like.js"></script> -->

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-15922433-1");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>
