<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link type="image/x-icon" rel="icon" href="favicon.ico" />
<link type="image/x-icon" rel="shortcut icon" href="favicon.ico" />
<!--[if IE]><script type="text/javascript" src="js/html5.js"></script><![endif]-->
<link rel="stylesheet" type="text/css" href="css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/vim-like.css" />
<title>Alipay-SofaMVC - 闲耘™.Wiki</title>
</head>
<body>
<div id="wrapper">
<header>
<nav>
    <ul>
        <li class="first"><a href="http://hotoo.me/" title="Home">Home</a></li>
        <li><a href="http://blog.hotoo.me/" title="Blog">Blog</a></li>
        <li class="actived"><a href="http://wiki.hotoo.me/" title="Wiki">Wiki</a></li>
        <li><a href="https://twitter.com/hotoo" title="Twitter">Twitter</a></li>
        <li class="last"><a href="http://github.com/hotoo" title="Project">Project</a></li>
        <!-- li class="last"><a href="../resume/resume.html" title="About Me">README</a></li -->
    </ul>
</nav>
</header>
<article>

    
<p>
&lt;!--%nohtml--&gt;
</p>

<h1 id="toc_1">支付宝 SofaMVC</h1>
<p>
这部分是支付宝内部框架(SofaMVC) 一些简单的内容，对于前端工程师了解后台运作方式
或许有些许帮助。
</p>

<h2 id="toc_1.1">导入项目到 Eclipse</h2>
<ol>
<li>
先执行命令初始化 Eclipse 项目
<pre>
%PROJECT_HOME%&gt; mvn eclipse:eclipse
</pre>
    Note: 提交项目时，可以使用如下命令清除生成的项目文件：
<pre>
%PROJECT_HOME%&gt; mvn eclipse:clean
</pre>

<li>
导入 Java 项目到 Eclipse。<br />
    Import -&gt; Existing Projects into Workspace -&gt; Select root directory:
<pre>
D:\workbench\demo
</pre>

<li>
添加项目变量：<br />
    项目目录 -&gt; 属性 -&gt; Java Build Path -&gt; Libraries -&gt; Add Variable -&gt; Configure Variables... -&gt; New...<br />
    Name: M2_REPO<br />
    Path: D:/dwtask/M2_REPO/sofa2.m2
<pre>
M2_REPO = D:/dwtask/M2_REPO/sofa2.m2
</pre>

<li>
导入模板文件<br />
    New -&gt; Java Project -&gt; Create project from existing source<br />
    D:\workbench\demo\htdocs

<li>
运行<br />
    demo-test:src/test/java/com.alipay.dss.test.WebSofaStarter.java<br />
    Run As -&gt; Java Application.

</ol>

<p>
对于已有项目，需要修改
Eclipse:     %PROJECT_NAME%-test/src/test/resources/sofa-test-config.properties
Explore: %PROJECT_HOME%/app/test/src/test/resources/sofa-test-config.properties
</p>
<pre>
%PROJECT_NAME%_template=%PROJECT_HOME%/htdocs/templates
</pre>

<h2 id="toc_1.2">配置 $staticServer</h2>
<p>
\${PROJECT_HOME}\app\web\home\src\main\resources\uri-brokers.xml
</p>
<pre>
&lt;content-uri name="staticServer" expose="true"&gt;
    &lt;serverURI&gt;${core_protocol}://${core_domainName}:${core_web_port}&lt;/serverURI&gt;
&lt;/content-uri&gt;
</pre>

<h2 id="toc_1.3">Add bundle</h2>
<p>
后台 Java 部分：
</p>
<pre>
%PROJECT_HOME%/app/web&gt; web bundle add --name cocoon
</pre>
<p>
参考： <a href="http://doc.alipay.net/pages/viewpage.action?pageId=11240141">SpringRoo使用</a>
</p>

<p>
前端 vm 部分在 %PROJECT_HOME%/htdocs/templates 下直接拷贝，或创建类似 home 的目录即可。
</p>

<p>
在 %PROJECT_HOME%/app/test/pom.xml 中的 <code>&lt;dependencies&gt;</code> 标签内添加：
</p>
<pre>
    &lt;dependency&gt;
        &lt;groupId&gt;com.alipay.dss&lt;/groupId&gt;
        &lt;artifactId&gt;demo-web-cocoon&lt;/artifactId&gt;
    &lt;/dependency&gt;
</pre>

<p>
在 %PROJECT_HOME%/assembly/ear/pom.xml 的 <code>&lt;artifactItems&gt;</code> 标签内添加：
</p>
<pre>
    &lt;artifactItem&gt;
        &lt;groupId&gt;com.alipay.dss&lt;/groupId&gt;
        &lt;artifactId&gt;demo-web-cocoon&lt;/artifactId&gt;
    &lt;/artifactItem&gt;
</pre>

<p>
对于新建的 bundle 要导入到 Eclipse 中需要先清理并重新导入。
</p>
<pre>
%PROJECT_HOME%&gt; mvn clean eclipse:clean
%PROJECT_HOME%&gt; mvn eclipse:eclipse
</pre>

<p>
<strong>注：</strong>
home 之外的 Bunlde(Bunlde 和 Car 没明白是什么意思？) 必须 Java 类和 vm 访问的文件同名。
某些版本的 Sofa 貌似是用过 <code>@RequestMapping("/index.htm")</code> 隐私的，而无需类名相同。
困惑。
</p>

<p>
新建的 Java 类需要重启服务。
</p>

<p>
<strong>关键字</strong>
</p>
<ul>
<li>
<code>$homeModule.setTarget("status.vm")</code>

<li>
<code>$tile.setTemplate("")</code>

<li>
<code>$rundata.moduleInfo.setLayoutTemplate("layout/mobile.vm", false)</code>

<li>
<code>setParameter("name", "value")</code>

</ul>

<p>
<span class="todo">TODO:</span>
layout/
screen/
tile/
</p>

<h2 id="toc_1.4">链接</h2>
<p>
<strong>内部系统链接</strong><br />
使用 <code>xxxModule.setTarget("yyy.vm")</code> 而不是直接调用 <code>yyy.htm</code>。<br />
<span class="todo">TODO:</span> xxxModule 是什么？
</p>
<pre>
&lt;a href="$homeModule.setTarget('list.vm')"&gt;List&lt;/a&gt;
</pre>

<p>
带参数的链接，参数直接接在 setTarget 方法之后，而不是作为其参数。
</p>
<pre>
#set($menuUrl="$homeModule.setTarget('lifeHelper.vm')?src=ui_lifehelper_index")
</pre>

<p>
<strong>外部系统链接</strong><br />
直接使用绝对路径。
</p>

<p>
<strong>静态资源的引用</strong><br />
使用 <code>$xxxServer.getURI("path/file.name")</code><br />
<span class="todo">TODO:</span> 为什么要分成 imageServer 和 staticServer，而 staticServer 不分成 cssServer 和 jsServer ？
</p>
<pre>
&lt;img src="$imageServer.getURI('assets/i/cn/publicpay/feePic.png')" alt="缴费单条形码" /&gt;
&lt;script type="text/javascript" charset="utf-8" src="$staticServer.getURI('/js/arale/xbox.js')"&gt;&lt;/script&gt;
</pre>

<p>
<code>parse()</code> 和 <code>$tile.setTemplate()</code>
<table>
<tr>
<th>
&nbsp;
</th>
<th>
#parse()
</th>
<th>
$tile.setTemplate()
</th>
</tr>
<tr>
<td>
时机
</td>
<td>
先插入，后解析
</td>
<td>
先解析，后插入
</td>
</tr>
<tr>
<td>
变量/参数
</td>
<td>
被 #parse 的页面共享变量
</td>
<td>
需要传入参数
</td>
</tr>
<tr>
<td>
controller
</td>
<td>
不需要
</td>
<td>
需要
</td>
</tr>
<tr>
<td>
配置默认 path
</td>
<td>
需要
</td>
<td>
不需要
</td>
</tr>
</table>
</p>

<p>
<strong>使用 layout/default.vm 之外的布局</strong>
</p>
<pre>
#set($layout = "home/layout/login.vm")
</pre>
<h2 id="toc_1.5">参考阅读</h2>
<ul>
<li>
<a href="Velocity.html">Velocity</a>

<li>
<a href="Velocity-Notes.html">Velocity-Notes</a>

<li>
<a href="http://doc.alipay.net/pages/viewpage.action?pageId=13605311">velocity模板开发</a>

<li>
<a href="http://doc.alipay.net/pages/viewpage.action?pageId=11245005">模板开发约定手册</a>

<li>
<a href="http://yekai.net/?p=232">Velocity模板开发常见问题分享</a>

<li>
<a href="http://personal.demo.alipay.net/user/vmflower.htm">VM开发分享</a>

</ul>


<script type="text/javascript">
function onSearch(){
    location.href = "search.html#"+document.getElementById("input_search").value;
    return false;
}
</script>
<div style="border-top:1px solid #ccc; background:#f6f6f6 none;padding:8px;">
    <form action="search.html" id="searchbox" onsubmit="return onSearch();">
        <input type="text" name="q" id="input_search" />
        <input type="submit" value="搜索" />
    </form>
</div>
</article>
<footer>
    <a href="index.html" id="back-home">&lsaquo; 首页</a>
    <p><a rel="license" href="http://creativecommons.org/licenses/by/2.5/"><img alt="Creative Commons License" style="border-width: 0pt;" src="http://i.creativecommons.org/l/by/2.5/88x31.png" align="right"></a>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/2.5/">Creative Commons Attribution 2.5 Generic License</a>.<br>
    Copyleft © 2010, Driven by <a href="http://code.google.com/p/vimwiki/">Vimwiki</a>, Theme by 闲耘™(@hotoo).
    </p>
    <p>本页最后修订于 %time_stamp%</p>
</footer>
</div>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<!--[if lte IE 6]><script type="text/javascript" src="js/ie6.js"></script><![endif]-->
<!-- <script type="text/javascript" src="js/WikiWords.js"></script>
<script type="text/javascript" src="js/vim-like.js"></script> -->

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-15922433-1");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>
